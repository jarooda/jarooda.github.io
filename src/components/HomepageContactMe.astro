---
import { Icon } from "astro-icon/components"
import AnimatedButton from "./shared/AnimatedButton.astro"

const url = import.meta.env.PUBLIC_CONTACT_ME_API
const socials = [
  {
    label: "github",
    icon: "logos:github-icon",
    url: "https://github.com/jarooda"
  },
  {
    label: "linkedin",
    icon: "logos:linkedin-icon",
    url: "https://linkedin.com/in/jaluwibowoaji"
  },
  {
    label: "upwork",
    icon: "logos:upwork",
    url: "https://www.upwork.com/freelancers/~010774d4112be0d77f?mp_source=share"
  },
  {
    label: "stackoverflow",
    icon: "logos:stackoverflow-icon",
    url: "https://stackoverflow.com/users/14604582/jalu-wibowo"
  },
  {
    label: "google developers",
    icon: "logos:google-developers",
    url: "https://g.dev/jaluwibowo"
  },
  {
    label: "twitter",
    icon: "logos:twitter",
    url: "https://twitter.com/jaluwibowoaji"
  },
  {
    label: "bluesky",
    icon: "logos:bluesky",
    url: "https://bsky.app/profile/jaluwibowo.id"
  }
]
---

<script>
  import Toastify from "toastify-js"
  import "toastify-js/src/toastify.css"
  class ContactMe extends HTMLElement {
    constructor() {
      super()

      // Read the message from the data attribute.
      const url = this.dataset.url
      const sendMsgBtn = document.getElementById("send-msg-btn")

      if (!sendMsgBtn) return

      sendMsgBtn.addEventListener("click", async () => {
        try {
          sendMsgBtn?.setAttribute("disabled", "disabled")
          sendMsgBtn?.classList.add("cursor-not-allowed")
          sendMsgBtn?.classList.add("opacity-50")

          const email = (document.getElementById("email") as HTMLInputElement)
            ?.value
          const name = (document.getElementById("name") as HTMLInputElement)
            ?.value
          const message = (
            document.getElementById("message") as HTMLInputElement
          )?.value

          if (!email) {
            throw new Error("Email is required!")
          }
          if (!name) {
            throw new Error("Name is required!")
          }
          if (!message) {
            throw new Error("Message is required!")
          }

          if (!url) {
            throw new Error("API is not ready")
          }

          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              email,
              name,
              message
            })
          })
          const data = await response.json()

          if (response.status === 200) {
            const emailElement = document.getElementById("email")
            const nameElement = document.getElementById("name")
            const messageElement = document.getElementById("message")

            if (emailElement instanceof HTMLInputElement)
              emailElement.value = ""
            if (nameElement instanceof HTMLInputElement) nameElement.value = ""
            if (messageElement instanceof HTMLTextAreaElement)
              messageElement.value = ""

            Toastify({
              text: data.message,
              duration: 2000,
              close: true,
              gravity: "top",
              position: "right",
              style: {
                background: "#22c55e"
              }
            }).showToast()
          } else {
            throw new Error(data.message)
          }
        } catch (error: any) {
          Toastify({
            text: error.message,
            duration: 2000,
            close: true,
            gravity: "top",
            position: "right",
            style: {
              background: "#ef4444"
            }
          }).showToast()
        } finally {
          sendMsgBtn?.removeAttribute("disabled")
          sendMsgBtn?.classList.remove("cursor-not-allowed")
          sendMsgBtn?.classList.remove("opacity-50")
        }
      })
    }
  }

  customElements.define("contact-me", ContactMe)
</script>

<contact-me data-url={url}>
  <section
    id="contactme"
    class="flex flex-col text-gray-700 dark:text-gray-300 z-[2] transition-colors duration-200"
  >
    <div class="mx-auto w-full lg:w-256 py-4 px-4">
      <div
        class="w-full flex flex-col md:flex-row text-center gap-0 md:gap-4 text-2xl md:text-5xl font-semibold"
      >
        <h1 class="shrink-0">Contact Me</h1>
      </div>
      <content class="text-md md:text-xl mt-5 md:mt-10 flex flex-col gap-2">
        <h2 id="social-target" class="text-xl md:text-2xl">
          You can find me on these platforms,
        </h2>
        <div
          id="social-floating"
          class="floating flex flex-wrap justify-center md:justify-start float-start md:flex-col gap-8 my-8"
        >
          {
            socials.map((social) => (
              <a
                href={social.url}
                target="_blank"
                class="flex flex-row gap-2 hover:drop-shadow-md w-10 h-10 md:w-12 md:h-12 items-center justify-center rounded-full bg-white dark:bg-gray-700 p-3 hover:scale-110 transition-all duration-200 shadow-sm dark:shadow-gray-500"
                aria-label={social.label}
                data-test={`social-${social.label}`}
              >
                <Icon
                  name={social.icon}
                  class="w-full h-full"
                />
              </a>
            ))
          }
        </div>
        <h2 class="text-xl md:text-2xl">Or reach me using form below,</h2>
        <form method="POST" class="mt-8 text-base">
          <div class="bg-white dark:bg-gray-700 p-6 rounded-lg w-full flex flex-wrap gap-1 transition-colors duration-200">
            <div class="relative z-0 w-full md:w-1/2 mb-4 group">
              <input
                type="email"
                name="email"
                id="email"
                data-test="input-email"
                class="block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-gray-100 bg-transparent border-0 border-b-2 border-gray-300 dark:border-gray-500 appearance-none focus:outline-none focus:ring-0 focus:border-green-700 dark:focus:border-green-500 peer"
                placeholder=" "
                required
              />
              <label
                for="email"
                class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-green-700 dark:peer-focus:text-green-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
                >Your Email</label
              >
            </div>
            <div class="relative z-0 w-full md:w-1/2 mb-4 group">
              <input
                type="text"
                name="name"
                id="name"
                data-test="input-name"
                class="block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-gray-100 bg-transparent border-0 border-b-2 border-gray-300 dark:border-gray-500 appearance-none focus:outline-none focus:ring-0 focus:border-green-700 dark:focus:border-green-500 peer"
                placeholder=" "
                required
              />
              <label
                for="name"
                class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-green-700 dark:peer-focus:text-green-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
                >Your Name</label
              >
            </div>
            <div class="relative z-0 w-full group">
              <textarea
                name="message"
                rows="5"
                id="message"
                data-test="input-message"
                class="resize-none block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-gray-100 bg-transparent border-0 border-b-2 border-gray-300 dark:border-gray-500 appearance-none focus:outline-none focus:ring-0 focus:border-green-700 dark:focus:border-green-500 peer"
                placeholder=" "
                required></textarea>
              <label
                for="message"
                class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-green-700 dark:peer-focus:text-green-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
                >Your Message</label
              >
            </div>
          </div>

          <div class="flex justify-center md:justify-end w-full mt-4">
            <AnimatedButton
              id="send-msg-btn"
              dataTest="send-msg-btn"
              type="button"
              iconName="ri:mail-send-fill"
              text="Send Message!"
              mobileBlock
            />
          </div>
        </form>
      </content>
    </div>
  </section>
</contact-me>

<style>
  .floating {
    @media screen and (min-width: 768px) {
      position: fixed;
      bottom: 0;
      right: 1rem;
      /* transform: translateY(-50%); */
      flex-direction: column;
      z-index: 3;
    }
  }

  .stay {
    position: relative;
    top: 0;
    right: 0;
    /* transform: translateY(0); */
    flex-direction: row;
    z-index: 1;
  }
</style>
